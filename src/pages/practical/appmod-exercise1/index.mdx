---
title: Application Modernization - Exercise 1
---

<PageDescription>

An example of a "no code changes required" modernization of an existing traditional WebSphere ND application to Liberty running in a Docker Container.

</PageDescription>

<AnchorLinks>
  <AnchorLink to="#scan-the-existing-application">Scan the Existing Application</AnchorLink>
  <AnchorLink to="#analyze-the-scan-results">Analyze the Scan Results</AnchorLink>
  <AnchorLink to="#configure-websphere-liberty">Configure WebSphere Liberty</AnchorLink>
  <AnchorLink to="#run-plantsbywebsphere-on-liberty">Run PlantsByWebSphere on Liberty</AnchorLink>
</AnchorLinks>

## Business Need

There are 4000+ existing traditional WebSphere ND customers and they all have legacy monolithic applications that the business has no desire to invest money or time in but wants to move to "the Cloud". In this exercise you will learn the skills to be able to demonstrate to these customers how **some** applications can be moved to Liberty in a Docker container and then be deployed to any Cloud without the need to make code changes. While this isn't the typical way that the Garage wants to engage with customers, it is going to be part of the overall modernization of their legacy Java portfolio and an important skill for you to have. This is known as a `runtime modernization` which doesn't address the technical debt in the application but does remove the technical debt provided by the Application Server itself.

## [MVP Statement](https://www.ibm.com/garage/method/practices/think/practice_minimum_viable_product/)

- **Who** Operations teams are tasked with moving from traditional WebSphere ND to "the Cloud" and don't have access to developers for the majority of the legacy Java portfolio.

- **What** This application is used by a small number of customers and will be replaced in 18 months with a new version. The operations team needs to move to "the Cloud" now and wants to standardize on Docker containers that they can run anywhere.

- **Wow** With a few simple steps you can move an application and the associated configuration to a Liberty runtime in a Docker container without changing code. This is something that can be repeated over and over in a factory type engagement.

## [Architecture]()

PlantsByWebSphere is a simple legacy monolith with a backend database (DB2).

## Technical Requirements
- This modernization exercise has the following requirements:

    - No code changes (you don't even have access to source code)
    - The target is to get the application running on Liberty in a Docker container on your laptop
    - The DB2 database will remain in it's current location (it is deployed in a container in the MOOC4 cluster exposed with a NodePort)

## Guide
- This exercise has the following steps

    - Run a pre-configured instance of traditional WebSphere in a Docker container on your laptop to simulate the existing customer envionment
    - Use the IBM Cloud Transformation Advisor Data Collector to scan the WebSphere runtime and the PlantsByWebSphere application
    - Load the scan results in to IBM Cloud Transformation Advisor running in your MOOC Red Hat OpenShift cluster.
    - Review the IBM Cloud Transformation Advisor analysis
    - Use the accelerators to build a Docker image with Liberty and the application
    - Run the newly created Docker image with application on Liberty on your laptop to demonstrate success

## Solution Links



### Scan the Existing Application

#### Setup
In order to simulate a real traditional WebSphere ND customer environment on your laptop we have provided you with a `Dockerfile` that will create a Docker image that you can run locally. This image will contain `traditional WebSphere`, the `PlantsByWebSphere` application as well as the `IBM Cloud Transformation Advisor Data Collector`.

<InlineNotification kind="info">

**Note:** In the real world you would work with the client WebSphere Administrators to execute the IBM Cloud Transformation Advisor Data Collector in their environment, but for this exercise it is easier to run this Docker image on your laptop.

</InlineNotification>

<InlineNotification kind="info">

**Note:** The DB2 database used by this application is at `52.117.164.118` on port `30465`

</InlineNotification>

- Clone the repository to your machine

    ```bash
    git clone https://github.com/ibm-cloud-architecture/icp-dev-workshop.git
    cd lab4/CreatePreConfiguredWASContainer
    ```

- Review the `Dockerfile`. Note that the DB2 JDBC drivers, compiled application EAR files and the IBM Cloud Transformation Advisor Data Collector (this was split in to 50mb chunks so it could easily be stored in GIT) are copied on to the image as well as `wsadmin` scripts which are executed at the end of the build. The `wsadmin` scripts are used to configure the WebSphere application server ready for the PlantsByWebSphere application.

- Review the `customCmd.properties` file. This file is used to ensure that the IBM Cloud Transformation Advisor Data Collector scans all of the files in the application. By default the IBM Cloud Transformation Advisor Data Collector ignores Java classes in the `com.ibm.websphere`, `net`, `org` packages and other packages that are typically used by open-source JARs. These packages are ignored as they are typically outside of the scope of what a client owns and create `false-positive` results in Transformation Advisor. This becomes a problem when the client's code is in a package such as `net.` or `org.` as their Java code will be ignored by the scanner.

    ```
    evaluation=--evaluate --excludePackages=com.informix,com.microsoft,com.sybase,com.sun,java,javax,net,org,oracle,sqlj,_ibmjsp --includePackages=com.ibm
    migration_liberty=--analyze --sourceAppServer=was855 --targetAppServer=liberty --targetCloud=dockerIBMCloud --includePackages=com.ibm --excludePackages=com.informix,com.microsoft,com.sybase,com.sun,java,javax,net,org,oracle,sqlj,_ibmjsp
    migration_was=--analyze --sourceAppServer=was855 --targetAppServer=was90 --targetCloud=vmIBMCloud --includePackages=com.ibm --excludePackages=com.informix,com.microsoft,com.sybase,com.sun,java,javax,net,org,oracle,sqlj,_ibmjsp
    #inventory=--inventory --excludeFiles=".*/directory/LargeXMLFileName.xml"
    #featureList=--featureList --excludeFiles=".*/directory/LargeXMLFileName.xml"
    #java_opt=-Xmx2g
    ```
- Review the `wsadmin.py` file and ensure that the `serverName` and `port` for the DataSources match the values of your DB2 database (above).

- Build the Docker image:

    ```bash
    docker build -t twas-plantsbywebsphere .
    ```

- Use `docker images` to check the size of the IBM provided traditional WebSphere image. If you happened to be wondering if traditional WebSphere runs in a Docker container then why are we moving to Liberty? **1.75GB** is one of the reasons... Having to hard code configuration values in configuration files like in the previous step is another reason (is traditional WebSphere can't read configuration from Environment Variables)

    ```bash
    docker images | grep websphere
    ibmcom/websphere-traditional profile 67b52a4c08ad 12 months ago 1.75GB
    ```

- Start an instance of the Docker Image

    ```bash
    docker run -d -p 9080:9080 -p 9443:9443 -p 9060:9060 -p 9043:9043 -v "$(pwd)":/data --name twas-plantsbywebsphere twas-plantsbywebsphere:latest
    ```

- Tail the logs for the Docker container and wait for the message shown below:

    ```
    docker logs -f twas-plantsbywebsphere

    ...

    *** CERTIFICATES THAT ARE EXPIRED OR BEYOND THE EXPIRATION THRESHOLD AND HAVE BEEN REPLACED ***;

    CWPKI0645I: Personal certificate alias "default" in KeyStore "NodeDefaultKeyStore((cell):DefaultCell01:(node):DefaultNode01)" was REPLACED.
    CWPKI0645I: Personal certificate alias "default" in KeyStore "NodeRSATokenKeyStore((cell):DefaultCell01:(node):DefaultNode01)" was REPLACED.
    ```

- This message is expected as this version of the traditional WebSphere Docker image is over 12 months old and the SSL certificates have expired. We will have to `stop` and `start` the container again to refresh these SSL certificates.

    ```
    docker stop twas-plantsbywebsphere
    docker start twas-plantsbywebsphere
    ```

- Tail the logs for the Docker container and wait for the message shown below:

    ```
    WSVR0001I: Server server1 open for e-business
    ```

- Login to the traditional WebSphere Administrative Console

    https://localhost:9043/ibm/console

    username: ```wsadmin``` password: ```passw0rd```

- Navigate to `Applications --> Application Types --> WebSphere enterprise applications` and validate that you see `HelloWorld` and `PlantsByWebsphere8`

    ![apps](images/twas-apps.jpg)

- Navigate to `Resources --> JDBC --> DataSources` and validate that you see `PlantsByWebSphereDataSource` and `PlantsByWebSphereDataSourceNONJTA`. These are the two DataSources that will be detected by the IBM Cloud Transformation Advisor Data Collector

    ![apps](images/twas-ds.jpg)

- Log out of the traditional WebSphere Administrative Console

- Access PlantsByWebSphere using http://localhost:9080/PlantsByWebSphere

    ![apps](images/twas-pbw.jpg)

- Click on one of the Specials such as the `Bonsai Tree`. If the screen shown below is displayed, the connection to the Database is working correctly.

    ![apps](images/twas-tree.jpg)

#### Run the IBM Cloud Transformation Advisor Data Collector
Now that you have validated that the PlantsByWebSphere application is running in the Docker container, it is time to run the IBM Cloud Transformation Advisor Data Collector.

- Enter the twas-plantsbywebsphere Docker container

    ```
    docker exec -it twas-plantsbywebsphere bash
    ```

- Navigate to the IBM Cloud Transformation Advisor Data Collector directory

    ```
    cd /demo/transformationadvisor-2.0.1
    ```

- Execute the IBM Cloud Transformation Advisor Data Collector

    ```
    ./bin/transformationadvisor -w /opt/IBM/WebSphere/AppServer -p AppSrv01 wsadmin passw0rd
    ```

- When prompted, accept the `License` agreement

- After a few minutes you will either see a `Thank you for uploading your data. You can proceed to the application UI for doing further analysis.` message or an error related to `unable to upload the data` which will occur if the IBM Cloud Transformation Advisor Data Collector can't access the IBM Cloud Transformation Advisor UI which is running in Red Hat OpenShift.

    ![apps](images/ta-upload.jpg)

- Validate that the results zip file has been created.

    ```
    ls -la AppSrv01.zip
    -rw-r--r-- 1 was was 340860 Nov 22 15:32 AppSrv01.zip
    ```

- Use CTRL+D to exit from the Docker container

- Download the `AppSrv01.zip` file from the Docker container

    ```
    docker cp twas-plantsbywebsphere:/demo/transformationadvisor-2.0.1/AppSrv01.zip .
    ```

- Stop and remove the Docker container

    ```
    docker stop twas-plantsbywebsphere
    docker rm twas-plantsbywebsphere
    ```

### Analyze the Scan Results
In this section you will upload the results from the IBM Cloud Transformation Advisor Data Collector to the IBM Cloud Transformation Advisor UI and analyze the findings.

- Using your `IBM Garage for Cloud - Development Cluster Dashboard`, navigate to `Transformation Advisor`

    ![apps](images/ta-dashboard.jpg)

- You may receive an `Authentication endpoint is broken at the moment.` message. Copy the `URL` to a new `incognito` browser session to solve the problem

- Add a new Workspace named `AppMod_{your initials}`

- Add a new Collection named `Lab1`

- Click `Upload data` and provide `AppSrv01.zip` from the previous section. After a few moments the results will be displayed as shown below:

    ![apps](images/ta-page1.jpg)

Take a moment to review the results. IBM Cloud Transformation Advisor has determined this application is `simple` to move to `Liberty to Private Cloud`.

- What happens if you change the `Preferred migration` target to `Liberty on Public Cloud`? Why did the **complexity** change?

- Hold your mouse over the `Complex` box. Why does IBM Cloud Transformation Advisor think you need a VPN?

- Click on the the `PlantsByWebSphere8.ear` and read the `Public Cloud to Private Cloud Network Connection` result.

Scroll down and note the `External Dependencies` that have been detected to be required by this application. Remember the DB2 database? IBM Cloud Transformation Advisor detected that the application used the database and is making sure that you are aware that if the move this application to the public cloud you'll either need to move the database or provide some type of connection back to it on-prem.

- Click the `<-- Recommendations` link at the top of the page and return to the reset the `Preferred migration` target to `Liberty on Private Cloud`

- Click on the the `PlantsByWebSphere8.ear` again and review the `Technology Issues` section.

- Scroll to the bottom of the page and review the `Technology Report`, `Inventory Report` and `Analysis Report`

- Note that at the top of each report the `command line parameters` are shown. This helps to validate that your settings in `customCmd.properties` have been deteceted

    ![pbw](images/ta-params.jpg)

- **Technology Report** provides a listing of the JEE features used by the application and maps them to the capabilities of the various WebSphere editions. This is a useful first step to determining whether this application will run on Liberty.

    ![pbw](images/ta-tech.jpg)

- **Inventory Report** provides:

    - a breakdown of the JEE components in the application which helps to give an idea of the size of the monolith and identify the number of EJBs and Web Services.
    ![pbw](images/ta-inventory.jpg)

    - a graphical representation of the application structure can also be used to see which JARs are included in the application which helps identify technical debt such as old versions of Struts, Spring, Hibernate and whether the application packages IBM or JEE JARs that can cause classloading issues later.
    ![pbw](images/ta-inventory2.jpg)

    - a `Utility JAR` listing at the bottom which can be used to see which packages are in each JAR which is especially useful if the client doesn't know which Java packages to scan. If you find client code in packages such as `org.` and `net.` listed in this part of the report it will be necessary to modify the `customCmd.properties` file and re-run the scan
    ![pbw](images/ta-inventory3.jpg)

- **Analysis Report** provides a breakdown of the issues found during the scan of the application. Review the `Severe` and `Warning` results using the `show rule help` and `show results` links. Note that the one severe result for this application is related to the user of `sendRedirect` and that the solution if problems are encountered during testing is to set a JVM property.

    ![pbw](images/ta-severe.jpg)

- Close the open report tabs and return to the `Recommendations` page

Let's go ahead and move this application to Liberty.

### Configure WebSphere Liberty
IBM Cloud Transformation Advisor creates some accelerators to speed up the process of migrating an application. These files are a starting point for most modernization journeys and require modification. In this section you will modify those files for PlantsByWebSphere.

- Click the `...` link on the `PlantsByWebSphere8.ear` line and select `view migration plan`

  ![pbw](images/ta-assets.jpg)

  * ```server.xml``` - IBM Cloud Transformation Advisor extracts most of the configuration from traditional WebSphere and generates a server.xml for Liberty to use.
  * ```Dockerfile``` - Used to create the docker image which includes the application, and configuration for Liberty.
  * ```Operator resources``` - Used in Red Hat OpenShift to deploy the application using the OpenLiberty operator.
  * ```pom.xml``` - Used for maven builds, particularly useful if the application does not already employ build scripts.

- Create a new directory in the lab4 folder

    ```bash
    cd ..
    mkdir liberty
    cd liberty
    ```

- Download `server.xml` and `Dockerfile` from IBM Cloud Transformation Advisor and place them in `lab4/liberty`

- Copy `plantsbywebspherev8.ear` from `lab4/binary/application` and place it in `liberty/binary/application`

- Copy `db2jcc.jar` and `db2jcc_licence_cu.jar` from
`lab4/binary/lib` and place them in `lab4/liberty/binary/lib`

- Issue the command `ls -laR` in the `liberty` folder and validate your structure is as shown below:

    ![liberty](images/liberty-ls.jpg)

- Open the `server.xml` file in your favorite editor and make the following changes:

  * change the `jpa-2.1` feature to `jpa-2.0`

  * uncomment the `dataSources` and `jdbcDrivers`

  * change the DB2 driver locations to be `/config/lib/db2jcc.jar` and `/config/lib/db2jcc_licence_cu.jar` for the `DB2_Universal_JDBC_Driver_Provider` and the `DB2_Universal_JDBC_Driver_Provider_(XA)` jdbcDrivers. (THERE ARE TWO SETS OF FILE NAMES THAT MUST BE CHANGED)

  * add `user="db2inst1" password="db2Pa2359w0rd123" transactional="false"` to the `properties.db2.jcc` line of the `PlantsByWebSphereDataSourceNONJTA` datasource

  * add `user="db2inst1" password="db2Pa2359w0rd123" transactional="true"` to the `properties.db2.jcc` line of the `PlantsByWebSphereDataSource` datasource

  * change `location="plantsbywebsphere8-1.0.0.war" name="PlantsByWebSphere8" type="war"/>` to the `location="plantsbywebsphere8.ear" name="PlantsByWebSphere8" type="ear"/>`

  * save your changes

  The modified `server.xml` should look like the one shown below:

    ```
    <?xml version="1.0" encoding="UTF-8"?><!--Generated by IBM TransformationAdvisor
    Thu Nov 21 20:49:39 GMT 2019--><server>
    <!--These elements have been identified from this application's configuration.-->
      <featureManager>
        <feature>beanValidation-1.1</feature>
        <feature>cdi-1.2</feature>
        <feature>ejbLite-3.2</feature>
        <feature>el-3.0</feature>
        <feature>javaMail-1.5</feature>
        <feature>jndi-1.0</feature>
        <feature>jpa-2.0</feature>
        <feature>jsf-2.2</feature>
        <feature>jsp-2.3</feature>
        <feature>servlet-3.1</feature>
      </featureManager>
      <!-- <variable name="DERBY_JDBC_DRIVER_PATH" value="${WAS_INSTALL_ROOT}/derby/lib"/> -->
      <httpEndpoint host="*" httpPort="9080" httpsPort="9443" id="defaultHttpEndpoint"/>
      <!-- <variable name="DB2UNIVERSAL_JDBC_DRIVER_NATIVEPATH" value=""/> -->
      <variable name="DERBY_JDBC_DRIVER_PATH" value="${shared.config.dir}/lib/global"/>
      <variable name="DB2UNIVERSAL_JDBC_DRIVER_NATIVEPATH" value="${shared.config.dir}/lib/global"/>
      <applicationManager autoExpand="true"/>
      <!--These elements are from the profile level configuration. Not all of them may be necessary for your application.-->
      <dataSource containerAuthDataRef="DefaultNode01/PlantsAuthAlias" id="PlantsByWebSphereDataSourceNONJTA" jdbcDriverRef="DB2_Universal_JDBC_Driver_Provider" jndiName="jdbc/PlantsByWebSphereDataSourceNONJTA">
        <properties.db2.jcc user="db2inst1" password="db2Pa2359w0rd123" transactional="false" beginTranForResultSetScrollingAPIs="false" beginTranForVendorAPIs="false" connectionSharing="1" databaseName="PLANTSDB" enableClientInformation="false" enableMultithreadedAccessDetection="false" errorDetectionModel="ExceptionMapping" jmsOnePhaseOptimization="false" name="PlantsByWebSphereDataSourceNONJTA" nonTransactionalDataSource="false" portNumber="30465" preTestSQLString="SELECT CURRENT SQLID FROM SYSIBM.SYSDUMMY1" propagateClientIdentityUsingTrustedContext="false" reauthentication="false" retrieveMessagesFromServerOnGetMessage="true" serverName="52.117.164.118" traceLevel="-1" unbindClientRerouteListFromJndi="false" useTransactionRedirect="false" validateNewConnection="false" validateNewConnectionRetryCount="100" validateNewConnectionRetryInterval="3"/>
        <connectionManager agedTimeout="0" connectionTimeout="180" maxIdleTime="1800" maxPoolSize="10" minPoolSize="0" reapTime="180"/>
      </dataSource>
      <dataSource containerAuthDataRef="DefaultNode01/PlantsAuthAlias" id="PlantsByWebSphereDataSource" jdbcDriverRef="DB2_Universal_JDBC_Driver_Provider_(XA)" jndiName="jdbc/PlantsByWebSphereDataSource">
        <properties.db2.jcc user="db2inst1" password="db2Pa2359w0rd123" transactional="true" beginTranForResultSetScrollingAPIs="false" beginTranForVendorAPIs="false" connectionSharing="1" databaseName="PLANTSDB" enableClientInformation="false" enableMultithreadedAccessDetection="false" errorDetectionModel="ExceptionMapping" name="PlantsByWebSphereDataSource" nonTransactionalDataSource="false" portNumber="30465" preTestSQLString="SELECT CURRENT SQLID FROM SYSIBM.SYSDUMMY1" propagateClientIdentityUsingTrustedContext="false" reauthentication="false" retrieveMessagesFromServerOnGetMessage="false" serverName="52.117.164.118" traceLevel="-1" unbindClientRerouteListFromJndi="false" useTransactionRedirect="false" validateNewConnection="false" validateNewConnectionRetryCount="100" validateNewConnectionRetryInterval="3"/>
        <connectionManager agedTimeout="0" connectionTimeout="180" maxIdleTime="1800" maxPoolSize="10" minPoolSize="0" reapTime="180"/>
      </dataSource>
      <jdbcDriver id="DB2_Universal_JDBC_Driver_Provider" javax.sql.DataSource="com.ibm.db2.jcc.DB2ConnectionPoolDataSource">
          <library>
              <file name="/config/lib/db2jcc.jar"/>
              <file name="/config/lib/db2jcc_license_cu.jar"/>
          </library>
      </jdbcDriver>
      <jdbcDriver id="DB2_Universal_JDBC_Driver_Provider_(XA)" javax.sql.DataSource="com.ibm.db2.jcc.DB2XADataSource">
          <library>
              <file name="/config/lib/db2jcc.jar"/>
              <file name="/config/lib/db2jcc_license_cu.jar"/>
          </library>
      </jdbcDriver>
      <authData id="DefaultNode01/PlantsAuthAlias" password="???" user="db2inst1"/>
      <application id="PlantsByWebSphere8" location="plantsbywebsphere8.ear" name="PlantsByWebSphere8" type="ear"/>
    </server>
    ```

- Review the generated Dockerfile `liberty/Dockerfile` in your favorite editor. Note that this Dockerfile expects the maven build to be triggered as part of this Docker build and then the generated war is copied to the Liberty runtime.

- Given that we aren't going to build the application in this way we are going to replace the entire contents of the Dockerfile as shown below:

    ```
    FROM ibmcom/websphere-liberty:webProfile7-ubi-min-amd64

    ARG SSL=true

    ARG MP_MONITORING=true
    ARG HTTP_ENDPOINT=false

    COPY ./server.xml /config
    COPY ./binary/application/* /config/apps/
    RUN mkdir /config/lib
    COPY ./binary/lib/* /config/lib/

    USER root
    RUN configure.sh
    USER 1001

    # Upgrade to production license if URL to JAR provided
    ARG LICENSE_JAR_URL
    RUN \
       if [ $LICENSE_JAR_URL ]; then \
         wget $LICENSE_JAR_URL -O /tmp/license.jar \
         && java -jar /tmp/license.jar -acceptLicense /opt/ibm \
         && rm /tmp/license.jar; \
       fi

    ```

### Run PlantsByWebSphere on Liberty
Now you are ready to build and run the Docker image that contains WebSphere Liberty and the PlantsByWebSphere application.

- Build the image using the following command

    ```
    docker build -t plantsbyliberty .
    ```

- Check the size of the newly created image and note that it is much smaller that the traditional WebSphere image and more `cloud-ready`

    ```
    docker images | grep plantsbyliberty

    ```

- Run an instance of the new container using the following command:

    ```
    docker run -d -p 9080:9080 -p 9443:9443 --name plantsbyliberty plantsbyliberty
    ```

- Tail the logs for the docker container and wait for the `CWWKT0016I: Web application available (default_host): http://0c59e31137ff:9080/PlantsByWebSphere/` message to be displayed

- Open browser to http://localhost:9080/PlantsByWebSphere and confirm the app working as expected with the DB2 data by clicking the `Flowers` link.

    ![pbw](images/lab4/pbwflowers.jpg)

- Stop and remove the Docker container using the following commands:

    ```bash
    docker stop plantsbyliberty
    docker rm plantsbyliberty
    ```

That's it. You now have this application running on Liberty in a Container. For next steps you would likely push this image to a Red Hat OpenShift Image Repository and deploy the application using the OpenLiberty Operator. If the client was interested in adding CI/CD automation you may also go back to the source code and automate CI and then automate deployment using CD.

## Summary

You have now completed the first of two AppMod exercises. This exercise demonstrated a simple `runtime` modernization scenario.
